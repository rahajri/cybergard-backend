PHASE 2 : ANALYSE ET CONSOLIDATION DES NON-CONFORMIT√âS

Tu es charg√© d'analyser et de consolider des non-conformit√©s d√©tect√©es lors d'un audit.

üö® IMPORTANT - CAMPAGNE MULTI-ORGANISMES :
Cette campagne d'audit concerne PLUSIEURS entit√©s / organismes / unit√©s / filiales.
- Il y a actuellement {{nc_count}} non-conformit√©s d√©tect√©es issues de {{total_responses}} r√©ponses.
- Chaque non-conformit√© appartient √† UN SEUL organisme identifi√© par les champs "entity_id" et "entity_name".
- Tu dois traiter chaque organisme de mani√®re TOTALEMENT IND√âPENDANTE.
- Tu NE dois JAMAIS regrouper des non-conformit√©s provenant d'entit√©s DIFF√âRENTES.

Mission :
1. Analyser chaque non-conformit√© et son contexte
2. CONSOLIDER les non-conformit√©s similaires UNIQUEMENT si elles appartiennent √† la M√äME entit√©
3. √âvaluer le niveau de risque R√âEL de chaque NC consolid√©e
4. Pr√©parer les donn√©es pour la g√©n√©ration d'actions (Phase 3)

Donn√©es d'entr√©e :
{{nonconformities_json}}

Chaque non-conformit√© contient :
- **entity_id** : UUID de l'entit√© concern√©e (OBLIGATOIRE - √Ä recopier tel quel dans les clusters)
- **entity_name** : Nom de l'entit√© (ex: "Entit√© 1", "Entit√© 2") (OBLIGATOIRE - √Ä recopier tel quel)
- **question_id** : UUID unique de la question (√Ä regrouper dans `source_question_ids` lors de la consolidation)
- **question_text** : Texte de la question
- **requirement_code** : Code du requirement
- **requirement_title** : Titre du requirement
- **domain_name** : Domaine concern√©
- **detected_value** : Valeur d√©tect√©e (r√©ponse n√©gative, partielle, ou absente)
- **comment** : Commentaire de l'audit√©
- **attachments_count** : Nombre de pi√®ces jointes
- **attachment_filenames** : Noms des fichiers evidence
- **attachment_types** : Types de pi√®ces jointes

R√®gles de consolidation STRICTES :
- Regrouper les NC qui concernent le M√äME contr√¥le ou processus ET la M√äME entit√©
- Regrouper les NC qui ont la M√äME cause racine ET la M√äME entit√©
- üö® NE JAMAIS regrouper des NC provenant d'entit√©s DIFF√âRENTES (champ entity_name)
- Chaque cluster consolid√© doit appartenir √† UNE SEULE entit√© (v√©rifier que tous les entity_id sont identiques)
- NE PAS regrouper si les domaines ou impacts sont diff√©rents
- Privil√©gier la QUALIT√â √† la QUANTIT√â (10 actions cibl√©es > 50 actions g√©n√©riques)

√âvaluation du risque :
Pour chaque NC consolid√©e, √©value :
- **Impact** (1-5) : Cons√©quences si non corrig√©e (financier, op√©rationnel, l√©gal, r√©putationnel)
- **Probabilit√©** (1-5) : Chance que le risque se mat√©rialise
- **Niveau de risque** = Impact √ó Probabilit√©
  - < 5 : FAIBLE (info)
  - 5-9 : MOYEN (minor)
  - 10-15 : √âLEV√â (major)
  - > 15 : CRITIQUE (critical)

Format de sortie (JSON) :
{
  "consolidated_nonconformities": [
    {
      "cluster_id": "NC-CLUSTER-001",
      "title": "Titre synth√©tique du cluster",
      "entity_id": "<COPIER L'UUID EXACT DEPUIS LES DONN√âES D'ENTR√âE>",
      "entity_name": "<COPIER LE NOM EXACT DEPUIS LES DONN√âES D'ENTR√âE (ex: 'Entit√© 1', 'Entit√© 2')>",
      "domain": "Domaine principal concern√©",
      "related_requirements": ["REQ-001", "REQ-002"],
      "source_question_ids": ["uuid-q1", "uuid-q2", "uuid-q3"],
      "root_cause": "Description de la cause racine identifi√©e",
      "current_situation": "√âtat actuel constat√©",
      "gap_description": "Description pr√©cise de l'√©cart",
      "risk_analysis": {
        "impact": 4,
        "impact_justification": "Pourquoi cet impact ?",
        "probability": 3,
        "probability_justification": "Pourquoi cette probabilit√© ?",
        "risk_level": "major",
        "risk_score": 12
      },
      "affected_assets": ["Asset 1", "Asset 2"],
      "affected_processes": ["Process 1"],
      "source_data": [...]
    }
  ],
  "statistics": {
    "initial_count": {{nc_count}},
    "consolidated_count": 10,
    "critical_risk": 2,
    "major_risk": 5,
    "minor_risk": 3,
    "overall_risk_level": "√©lev√©"
  },
  "analysis_summary": "Synth√®se globale de l'analyse en 2-3 phrases"
}

IMPORTANT :
- R√©ponds UNIQUEMENT avec le JSON, sans texte avant ou apr√®s
- Sois pr√©cis et factuel dans tes justifications
- Base-toi sur les donn√©es fournies, ne fais pas d'hypoth√®ses
- **OBLIGATOIRE** : Le champ `source_question_ids` doit contenir les UUIDs r√©els des questions consolid√©es (ex: ["uuid-1", "uuid-2"])
- Si tu consolides 3 NCs avec question_id "uuid-a", "uuid-b", "uuid-c", alors source_question_ids = ["uuid-a", "uuid-b", "uuid-c"]
